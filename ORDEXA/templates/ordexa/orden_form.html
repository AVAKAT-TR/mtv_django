<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Nueva Coti</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 30px;
    }
    h1 { text-align: center; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: center;
    }
    th { background-color: #f2f2f2; }
    input[type="text"], input[type="number"], input[type="date"], select {
      width: 150px;
      padding: 4px;
      font-size: 13px;
    }
    #totales {
      margin-top: 20px;
      width: 40%;
    }
    #totales input { text-align: right; }
    button {
      margin-top: 10px;
      padding: 6px 12px;
      font-size: 14px;
      background-color: #3c6e71;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover { background-color: #2a5052; }
  </style>
  <script>
    // --- Cargamos los productos desde el backend ---
    const productos = {{ productos_json|safe }};

    function formatNumber(num) {
      return num.toLocaleString("es-CL");
    }

    function actualizarPrecio(select) {
      const row = select.closest("tr");
      const id = select.value;

      const descripcionInput = row.querySelector('input[name$="-descripcion"]');
      const precioInput = row.querySelector('input[name$="-precio"]');

      if (id && productos[id]) {
        descripcionInput.value = productos[id].descripcion;
        precioInput.value = productos[id].precio;
      } else {
        descripcionInput.value = "";
        precioInput.value = "";
      }

      calcularTotales();
    }

    function calcularTotales() {
      let subtotal = 0;
      const filas = document.querySelectorAll("#items-table tr.item-row");

      filas.forEach(fila => {
        const cantidad = parseFloat(fila.querySelector('input[name$="-cantidad"]').value) || 0;
        const precio = parseFloat(fila.querySelector('input[name$="-precio"]').value) || 0;
        const total = cantidad * precio;

        const totalInput = fila.querySelector(".total-item");
        if (totalInput) totalInput.value = total > 0 ? formatNumber(total) : "";

        subtotal += total;
      });

      const descuento = subtotal * 0.05;
      const totalFinal = subtotal - descuento;

      document.getElementById("subtotal").value = formatNumber(subtotal);
      document.getElementById("descuento").value = formatNumber(descuento);
      document.getElementById("id_monto_total").value = formatNumber(totalFinal);
      document.getElementById("monto_total_hidden").value = totalFinal;
    }

    window.addEventListener("DOMContentLoaded", () => {
      document.querySelectorAll("#items-table input, #items-table select").forEach(el => {
        el.addEventListener("input", calcularTotales);
        el.addEventListener("change", calcularTotales);
      });
    });
  </script>
</head>
<body>
  <h1>Nueva Orden de Cotización</h1>
  <form method="post">
    {% csrf_token %}

    <p>Comprador: {{ form.comprador }}</p>
    <p>Fecha emisión: {{ form.fecha_emision }}</p>
    <p>Fecha envio: {{ form.fecha_vencimiento }}</p>

    <h3>Detalle de ítems</h3>
    <table id="items-table">
      <tr>
        <th>Producto</th>
        <th>Descripción</th>
        <th>Unidades</th>
        <th>Precio unitario</th>
        <th>Total</th>
      </tr>
      {{ formset.management_form }}
      {% for f in formset %}
      <tr class="item-row">
        <td>{{ f.producto }}</td>
        <td>{{ f.descripcion }}</td>
        <td>{{ f.cantidad }}</td>
        <td>{{ f.precio }}</td>
        <td><input type="text" class="total-item" readonly></td>
      </tr>
      {% endfor %}
    </table>

    <table id="totales">
      <tr>
        <td>Valor total:</td>
        <td><input type="text" id="subtotal" readonly></td>
      </tr>
      <tr>
        <td>Descuento transferencia (5%):</td>
        <td><input type="text" id="descuento" readonly></td>
      </tr>
      <tr>
        <td><b>Valor Final:</b></td>
        <td><input type="text" id="id_monto_total" readonly></td>
      </tr>
    </table>

    <input type="hidden" name="monto_total" id="monto_total_hidden">

    <button type="submit">Guardar</button>
  </form>
  <a href="{% url 'orden_list' %}">⬅ Volver</a>
</body>
</html>
