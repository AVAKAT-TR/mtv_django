<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Cotización</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 30px;
    }
    h1 { text-align: center; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: center;
    }
    th { background-color: #f2f2f2; }
    input[type="text"], input[type="number"], input[type="date"], select {
      width: 150px;
      padding: 4px;
      font-size: 13px;
    }
    #totales {
      margin-top: 20px;
      width: 40%;
    }
    #totales input { text-align: right; }
    button {
      margin-top: 10px;
      padding: 6px 12px;
      font-size: 14px;
      background-color: #3c6e71;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover { background-color: #2a5052; }
  </style>





<script>
  // --- Productos cargados desde Django ---
  const productos = {{ productos_json|safe }};

  function formatNumber(num) {
    return (isNaN(num) ? 0 : num).toLocaleString("es-CL");
  }

  function actualizarPrecio(select) {
    const row = select.closest("tr");
    const id = select.value;

    const descripcionInput = row.querySelector('input[name$="-descripcion"]');
    const precioInput = row.querySelector('input[name$="-precio"]');

    if (id && productos[id]) {
      descripcionInput.value = productos[id].descripcion;
      precioInput.value = productos[id].precio;
    } else {
      descripcionInput.value = "";
      precioInput.value = "";
    }
    calcularTotales();
  }

  function calcularTotales() {
    let subtotal = 0;

    // --- Calcular totales de productos normales ---
    const filas = document.querySelectorAll("#items-table tr.item-row");
    filas.forEach(fila => {
      const cantidad = parseFloat(fila.querySelector('input[name$="-cantidad"]').value) || 0;
      const precio = parseFloat(fila.querySelector('input[name$="-precio"]').value) || 0;
      const total = cantidad * precio;

      const totalInput = fila.querySelector(".total-item");
      if (totalInput) totalInput.value = total > 0 ? formatNumber(total) : "";

      subtotal += total;
    });

    // --- Calcular productos especiales (hasta 4) ---
    for (let i = 1; i <= 4; i++) {
      const cantidad = parseFloat(document.querySelector(`input[name="especial_cantidad_${i}"]`)?.value) || 0;
      const precio = parseFloat(document.querySelector(`input[name="especial_precio_${i}"]`)?.value) || 0;
      const total = cantidad * precio;

      // actualizar el campo total visual de cada producto especial
      const totalInput = document.querySelectorAll(".total-item-especial")[i - 1];
      if (totalInput) totalInput.value = total > 0 ? formatNumber(total) : "";

      subtotal += total; // se suma al total general
    }

    // --- Leer descuento dinámico desde el campo del formulario ---
    const descuentoInput = document.getElementById("id_descuento");
    const descuentoPorcentaje = parseFloat(descuentoInput ? descuentoInput.value : 0) || 0;

    const descuento = subtotal * (descuentoPorcentaje / 100);
    const totalFinal = subtotal - descuento;

    // --- Actualizar campos en pantalla ---
    document.getElementById("subtotal").value = formatNumber(subtotal);
    document.getElementById("descuento_monto").value = formatNumber(descuento);
    document.getElementById("id_monto_total").value = formatNumber(totalFinal);
    document.getElementById("monto_total_hidden").value = totalFinal;
  }

  window.addEventListener("DOMContentLoaded", () => {
    // Escucha cambios en productos normales
    document.querySelectorAll("#items-table input, #items-table select").forEach(el => {
      el.addEventListener("input", calcularTotales);
      el.addEventListener("change", calcularTotales);
    });

    // Escucha cambios en los 4 productos especiales
    for (let i = 1; i <= 4; i++) {
      const cantidad = document.querySelector(`input[name="especial_cantidad_${i}"]`);
      const precio = document.querySelector(`input[name="especial_precio_${i}"]`);
      if (cantidad) cantidad.addEventListener("input", calcularTotales);
      if (precio) precio.addEventListener("input", calcularTotales);
    }

    // Escucha cambios en el descuento (%)
    const descuentoInput = document.getElementById("id_descuento");
    if (descuentoInput) {
      descuentoInput.addEventListener("input", calcularTotales);
      descuentoInput.addEventListener("change", calcularTotales);
    }

    calcularTotales();
  });
</script>






</head>
<body>
  <h1>Nueva Cotización :v</h1>
  <form method="post">
    {% csrf_token %}

    <p>Comprador: {{ form.comprador }}</p>
    <p>Fecha emisión: {{ form.fecha_emision }}</p>
    <p>Fecha envio: {{ form.fecha_vencimiento }}</p>

    <h3>Detalle de Productos</h3>
    <table id="items-table">
      <tr>
        <th>Producto</th>
        <th>Descripción</th>
        <th>Unidades</th>
        <th>Precio unitario</th>
        <th>Total</th>
      </tr>
      {{ formset.management_form }}
      {% for f in formset %}
      <tr class="item-row">
        <td>{{ f.producto }}</td>
        <td>{{ f.descripcion }}</td>
        <td>{{ f.cantidad }}</td>
        <td>{{ f.precio }}</td>
        <td><input type="text" class="total-item" readonly></td>
      </tr>
      {% endfor %}
    </table>
    



  <table>
    <tr class="item-row especial">
      <td colspan="5" style="background-color:#f7f7f7; font-weight:bold;">Productos especiales</td>
    </tr>
    <tr>
      <th style="background-color:#f7f7f7;">Descripción :V</th>
      <th style="background-color:#f7f7f7;">Unidades</th>
      <th style="background-color:#f7f7f7;">Precio Unitario</th>
      <th style="background-color:#f7f7f7;">Total</th>
    </tr>

    {% for i in "1234" %}
    <tr class="item-row especial">
      <td><input type="text" name="especial_tipo_{{i}}" placeholder="Descripción del producto" style="width:95%"></td>
      <td><input type="number" min="0" name="especial_cantidad_{{i}}" value="0" style="width:80px"></td>
      <td><input type="number" min="0" name="especial_precio_{{i}}" value="0" style="width:100px"></td>
      <td><input type="text" class="total-item-especial" readonly></td>
    </tr>
    {% endfor %}
  </table>



    <table id="totales">
      <tr>
        <td>Valor total:</td>
        <td><input type="text" id="subtotal" readonly></td>
      </tr>
      <tr>
        <td>Descuento (%):</td>
        <td>
          {{ form.descuento }} %
        </td>
      </tr>
      <tr>
        <td>Monto de descuento:</td>
        <td><input type="text" id="descuento_monto" readonly></td>
      </tr>
      <tr>
        <td><b>Valor Final:</b></td>
        <td><input type="text" id="id_monto_total" readonly></td>
      </tr>
      <!--
      <tr class="item-row especial">
      <td colspan="5" style="text-align:left; font-weight:bold; background-color:#f7f7f7;">
        Producto especial (editable)
      </td>
      </tr>
      -->


      <!--
      <tr class="item-row especial">
        <td><input type="text" placeholder="Nombre del producto especial" name="especial_nombre" style="width:95%"></td>
        <td><input type="text" placeholder="Descripción" name="especial_descripcion" style="width:95%"></td>
        <td><input type="number" min="0" step="1" name="especial_cantidad" style="width:80px"></td>
        <td><input type="number" min="0" step="100" name="especial_precio" style="width:120px"></td>
        <td><input type="text" class="total-item-especial" readonly></td>
      </tr>
    -->


    </table>

    <input type="hidden" name="monto_total" id="monto_total_hidden">


    <button type="submit">Guardar</button>
  </form>
  <a href="{% url 'orden_list' %}">⬅ Volver</a>
</body>
</html>
